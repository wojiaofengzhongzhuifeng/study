# Event Loop



## Nodejs

### 执行原则

1. 有三个重要阶段

   ![](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/image-host/master/img/20190522105402.png)

2. 一般来说，从 poll 开始执行

### 示例代码

```javascript
setTimeout(()=>{
  setImmediate(()=>{
    console.log("setImmediate 1")
    setTimeout(()=>{
      console.log("settimeout 1")
    }, 0)
  })

  setTimeout(()=>{
    console.log('settimeout 2');
    setImmediate(()=>{
      console.log('setImmediate 2');
    })
  }, 0)
}, 1000)
```

## 前端

### 执行原则

1. 任务分类

2. 遇到 async，转化成 promise

   ![](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/image-host/master/img/20190522111237.png)

   

### 示例代码

#### 没有 async

重点：

执行完微任务 console.log("d") 后

立即向微任务队列中添加微任务 console.log("e")，紧接着执行微任务 console.log("e")。

并不是先执行宏任务 console.log("b")

```javascript
console.log('a');
setTimeout(() => {
    console.log('b');
}, 0);
console.log('c');
Promise.resolve().then(() => {
    console.log('d');
})
.then(() => {
    console.log('e');
});
console.log('f');
```





#### 有 async

重点：

1. await 后面的代码，全是 then 的内容

   ``` JavaScript
   // A async 代码
   await async2()
   console.log(2)
   setTimeout(()=>{
   	console.log(6)
   }, 0)
   
   // 转化成 promise 的代码
   async2().then(()=>{
     console.log(2)
     setTimeout(()=>{
       console.log(6)
     }, 0)
   })
   ```

2. 遇到 async2，直接执行即可(同步)



#### 例子代码

```javascript
async function async1(){
  console.log(1)
  // A，使用 async
  /*
	await async2()
	console.log(2)
	setTimeout(()=>{
		console.log(6)
	}, 0)
	*/
  async2().then(()=>{
    console.log(2)
    setTimeout(()=>{
      console.log(6)
    }, 0)
  })
}

async function async2(){
  console.log(3)
}

async1()

new Promise(function(resolve){
  console.log(4)
  resolve()
}).then(()=>{
  console.log(5)
})
```






跨域





## 同源策略

- 同协议：如都是http或者https
- 同域名：如都是[http://jirengu.com/a](https://link.zhihu.com/?target=http%3A//jirengu.com/a) 和[http://jirengu.com/b](https://link.zhihu.com/?target=http%3A//jirengu.com/b)
- 同端口：如都是80端口

上述有一个不同，浏览器会限制你在不同源的服务器活动，如果你想正常活动，需要**跨域**





## 跨域的几种方法

### JSONP

#### 实现过程

1. 直接输入 [url](https://photo.sina.cn/aj/index?page=1&cate=recommend)， 可以正常访问

2. 使用 ajax 获取数据

   https://jsbin.com/papiviralu/edit?html,js,console,output

   打开开发者工具，发现报错

   ![](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/image-host/master/img/20190514104204.png)

3. 可以通过这样的方式获取数据

   https://jsbin.com/cunapalemo/edit?html,js,console

   **jsoncallback=__ffffdsftest__, jsoncallback是后端提供的，__ffffdsftest__是前端自己定义的**

   此时后端返回的响应如下：

     ![](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/image-host/master/img/20190612134927.png)

     响应的意思是：执行 `__ffffdsftest__` 函数，函数的参数是响应内容

4. 封装函数

   https://jsbin.com/hoxitehedu/1/edit?js,console,output



### CORS

#### 思路

简略：

1. 浏览器发起简单请求，请求内容添加 `origin`，

2. 服务器检查`origin`，响应内容添加`Access-Control-Allow-Origin`
3. 浏览器解除限制

详细：

1. 跨域， 是浏览器阻止的

2. 为了实现跨域，需要服务端，客户端协同配合

3. 客户端**总是**会发起请求，但是能否获得响应，必须通过浏览器的检查

4. 对于简单的 ajax 请求，响应相应简单，浏览器对响应的检查相对少，不需要发送 CORS 预请求

5. 以下是简单的 ajax 请求

   - **HEAD**，**GET**，**POST**

   - 请求第二部分只有以下字段

     Accept

     Accept-Language

     Content-Language

     Last-Event-ID

     Content-Type（只能为`application/x-www-form-urlencoded`，`multipart/form-data`和`text/plain`其中一种）

6. ajax 请求是简单请求，它会为你的请求第二部分添加一个头部信息`Origin: 你的域名`（解释可能不正确）；

7. ajax 请求是非简单请求，需要在正式请求前发送一个「预检请求」，该请求 http 包含：

```http request
OPTIONS /cors HTTP/1.1
Origin: http://api.bob.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: X-Custom-Header
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
```
 
   该请求的意思是：
   
   1. 我发送一个请求方法为 options 的请求
   
   2. 我的请求 url 是 http://api.bob.com
   
   3. **我正式请求的方法是 PUT**
   
   4. **我正式请求 header 部分包含X-Custom-Header字段**

8. 服务端接受你的请求，并且在响应内容 header 写上这些字段

```http request
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: *
Access-Control-Allow-Headers: *
Access-Control-Allow-Credentials: *
Access-Control-Max-Age: 1728000
```   

[例子](https://github.com/wojiaofengzhongzhuifeng/study/blob/master/blog/daily.md#跨域问题)

### ❓如果客户端需要携带 cookie 跨域怎么办

1. 客户端，设置 XMLHttpRequest 实例的 withCredentials 属性为 true

   ```javascript
   var xhr = new XMLHttpRequest()
   xhr.withCredentials = true
   ```

2. 服务端，设置第二部分

   ```
   Access-Control-Allow-Credential: true
   Access-Control-Allow-Origin: 不能指定为 * ，必须明确设定一个域
   ```

   






# 跨域





## 同源策略

- 同协议：如都是http或者https
- 同域名：如都是[http://jirengu.com/a](https://link.zhihu.com/?target=http%3A//jirengu.com/a) 和[http://jirengu.com/b](https://link.zhihu.com/?target=http%3A//jirengu.com/b)
- 同端口：如都是80端口

上述有一个不同，浏览器会限制你在不同源的服务器活动，如果你想正常活动，需要**跨域**





## 跨域的几种方法

### JSONP

#### 实现过程

1. 直接输入 url https://photo.sina.cn/aj/index?page=1&cate=recommend，可以正常访问

2. 使用 ajax 获取数据

   https://jsbin.com/papiviralu/edit?html,js,console,output

   打开开发者工具，发现报错

   ![](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/image-host/master/img/20190514104204.png)

3. 可以通过这样的方式获取数据

   https://jsbin.com/cunapalemo/edit?html,js,console

   **"jsoncallback"这个字段是后端定的，需要问后端**

4. 封装函数

   https://jsbin.com/hoxitehedu/1/edit?js,console,output



### CORS

#### 思路

1. 跨域， 是浏览器阻止的

2. 为了实现跨域，需要服务端，客户端协同配合

3. 客户端总是会发起请求，但是能否获得响应，必须通过浏览器的检查

4. 对于简单的 ajax 请求，响应相应简单，浏览器对响应的检查相对少

5. 以下是简单的 ajax 请求

   - **HEAD**，**GET**，**POST**

   - 请求第二部分只有以下字段

     Accept

     Accept-Language

     Content-Language

     Last-Event-ID

     Content-Type（只能为`application/x-www-form-urlencoded`，`multipart/form-data`和`text/plain`其中一种）

6. 浏览器检测到你的 ajax 请求是简单请求，它会为你的请求第二部分添加一个头部信息`Origin: 你的域名`

7. 当请求内容发送到服务端后，服务端会检查`Origin`字段是否在许可范围内

8. 如果在的话，响应内容会添加`Access-Control-Allow-Origin`字段，还有其他字段，这里不说了





### 如果客户端需要携带 cookie 跨域怎么办

1. 客户端，设置 XMLHttpRequest 实例的 withCredentials 属性为 true

   ```javascript
   var xhr = new XMLHttpRequest()
   xhr.withCredentials = true
   ```

2. 服务端，设置第二部分

   ```
   Access-Control-Allow-Credential: true
   Access-Control-Allow-Origin: 不能指定为 * ，必须明确设定一个域
   ```

   




## 本月新东西

- [匹配服务](https://github.com/wojiaofengzhongzhuifeng/study/blob/master/blog/posts/2022%E5%B9%B403%E6%9C%8805%E6%97%A5-%E6%9B%B2%E5%BA%93%E5%90%8E%E7%AB%AF%E4%B8%9A%E5%8A%A1.md)



## 2022.03.07

### todo

- 完成批量请求歌词接口, **注意多请求问题导致服务挂掉**



---

### staging 环境出现问题, 如何调试?

如何调试线上环境代码??

![image-20220307111906554](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220307111906554.png)

---

### 生产环境有缓存, 测试环境没有缓存

体现在: 在断网的情况下, 请求生产环境的api, 依然能返回数据; 但是请求测试环境的 api ,不能返回数据,显示断网;

---

### 如何使用 redis 控制缓存?

#### redis 命令行操作

```
redis-server # 启动 redis
redis-cli -p 30001 # 连接集群 redis
redis-cli # 连接 redis
set name frank # 设置值
set name frank1 # 如果发现有相同 key , 覆盖
get name # 应该返回 frank1
del name # 删除
set test111 '{"name": "123321", "age": 1233}' # 保存对象,
exists test111 # 检查 key 是否存在, 1 存在, 0 不存在
exipre test111 10 # 设置一个 10s 过期时间
keys * # 展示所有 key
redis-cli shutdown # 关闭

```

#### 使用 spring boot 操作 redis

在 study 项目中完成需求

- 完成 com/dayuwuxian/ms/ops/app/server/config/RedisConfig.java bean
- 保证 /track?id=1 能正常使用



---

### spring boot 判断数据是否为空的方法汇总

- CollectionUtils.isEmpty(songs)

---

### sp 尝试接入 redis ,发现redis 没有生效

- 需要在本地起 redis 集群, 不能起单机

---

###  staging 接口无缘无故有问题?

https://staging.api.larkplayerapp.com/ms-ops-app-server/v2/songs/info?url=https://www.youtube.com/watch?v=6swmTBVI83k





---

###  客户端动态歌词缓存操作应该在哪里?

- 在 matrix-content-ops 操作 lyricMap 表的接口 /matrix-content-ops-read-server/v1/lyric-maps/external-id
- 在 matrix-content 操作 LRCLyric 表的接口 /matrix-music-content-read-server/v1/lrc-lyrics/id 

---





### 批量获取动态歌词

-  确定 api
- 学习 redis 相关接口
- 完成具体接口
  - controller 获取 list
  - list 遍历, 获取请求数据
  - 使用请求数据获取歌词数据(注意这个操作应该有缓存)
  - 组装响应数据



---

### 如何确定服务的端口号?

不要通过配置文件, 通过控制台
![image-20220307160148930](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220307160148930.png)



---

### 爬虫出现问题调试

- curl https://www.youtube.com/watch?v=6swmTBVI83k > test.html
- 另开一个命令行窗口
- cd 到某个路径
- mfmc -s "download test.html"



---







## 2022.03.06 

### java 项目的目录作用

![image-20220306122616289](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220306122616289.png)

- server 提供 api 接口
- client 提供 proxy



---

### java 需求: 现有 `List<Track>` , 想转化为 `List<TrackDTO>`, 如何操作?

拆成两步:

- 如何遍历 List
- 如何将 obj1 转化为 obj2 操作过程,出现问题

---

### 使用外键表示一对多关系的步骤

- 多方: 添加字段
  ![image-20220306201651820](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220306201651820.png)
- 一方: 添加字段, 打上 @oneToMany, 定义上一步定义的外键字段
  ![image-20220306201724321](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220306201724321.png)







---

![image-20220306205301748](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220306205301748.png)

![image-20220306205230812](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220306205230812.png)





## 2022.03.05

![image-20220305090103144](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220305090103144.png)

![image-20220305090312878](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220305090312878.png)

## 2220.03.04

### excel ,sql, sublime 选择所有列快速

- sublime 快速选择多个光标
  - command + A 选择所有
  - command + shift + L 



---

###  复制成 json 

![image-20220304142444678](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220304142444678.png)





---

### 页面换成 safari

![image-20220304142825111](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220304142825111.png)

---

### 日报,每天, 每周任务 节点 任务汇报

- 周五早上完成本周 weekly 和周报
  -  https://docs.google.com/spreadsheets/d/1-ihaSd_hl6kwmFMzjDDvWxZubOBdZNXSYo8d51nklUQ/edit#gid=877463871
  - https://docs.google.com/document/d/1rVqGDAUgSngjunvTlAC_hliBuQ1WzzFRyEGpqLVO5Sc/edit#
  - https://docs.google.com/spreadsheets/d/1KAQh-XJpBeZGuhn4xbkRxfeGoCuTaThBQuGmc7gGpZs/edit#gid=1466424531

- 日报: 1, 2, 3,  每天晚上完成. 4,5 周五早上完成
  - https://docs.google.com/spreadsheets/d/1KAQh-XJpBeZGuhn4xbkRxfeGoCuTaThBQuGmc7gGpZs/edit#gid=1466424531

---

### 权限问题

![image-20220304163035472](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220304163035472.png)

![image-20220304163130955](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220304163130955.png)

```
 chmod [-R] xyz 文件或目录
 chmod 755 ./staing.sh
```



---

### sql 每行某个字段之前之后插入字符串

![image-20220304165859534](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220304165859534.png)

```
UPDATE 表名
SET 字段名 = concat('|',字段名,'|')


UPDATE 表名
SET s3Key = concat('lrc/',s3Key,'.lrc')
```

---





## 2022.03.03

### 如何发布 springboot 后端服务?

---

在 eks 服务,注意服务名称不要选错
![image-20220303110938344](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220303110938344.png)

---



### 无法连接 staging 环境数据库?

https://github.com/wojiaofengzhongzhuifeng/study/blob/master/blog/month/2022-02.md#%E6%93%8D%E4%BD%9C%E7%94%9F%E4%BA%A7%E6%B5%8B%E8%AF%95-staging%E7%8E%AF%E5%A2%83%E6%95%B0%E6%8D%AE%E5%BA%93

---



### 看 zhichen 的 commit 看下有什么新收获





---

### 定义批量查询动态歌词的接口文档,并且实现



---





### python 处理

- 需要处理的 case 
  https://docs.google.com/document/d/1ZYVfthAgAWmdvBAF4PAqtdawLUFiAspQVER5znE_3Ek/edit#heading=h.97fzulrhzifg
- 思路
- 正常三段式
- 正常两段式
- 合集
- demo-存在用户手动上传的三段式信息
  ![image-20220303140957597](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220303140957597.png)
  - https://www.youtube.com/watch?v=g6yJVBaqMjo
  - https://www.youtube.com/watch?v=vBNO9vjCMYo
  - https://www.youtube.com/watch?v=CR7QizUf6Jo
  - https://www.youtube.com/watch?v=nAQFhNtyluk
  - https://www.youtube.com/watch?v=SaKw8-p8vFw
  - https://www.youtube.com/watch?v=0aZWoY4rkFo
  - https://www.youtube.com/watch?v=ZNSaHhaHIqQ
  - https://www.youtube.com/watch?v=OdRHBxfHQzM
  - 只有 artist https://www.youtube.com/watch?v=_N5yvjy_3X8
  - artist, song 都是 空: https://www.youtube.com/watch?v=s73cSJJgGIg
  - https://www.youtube.com/watch?v=dC5ie2VGvrw
  - https://www.youtube.com/watch?v=XIXxTL35faw
  - https://www.youtube.com/watch?v=5KlEwDkNPFc
  - https://www.youtube.com/watch?v=BM_3d5DE9Ks
  - https://www.youtube.com/watch?v=z6bMOYnP-XQ
  - 只有 artist https://www.youtube.com/watch?v=jFLN9lyEHx0
  - 只有歌曲 https://www.youtube.com/watch?v=oeviBGaU2bU
  - https://www.youtube.com/watch?v=3BXeKFB2-5Y
- demo-由youtube 自动识别的, 存在 「Auto-generated by YouTube」语句
  - https://www.youtube.com/watch?v=LiwDa5rCmYc
  - https://www.youtube.com/watch?v=aIFcLQFPWYI
  - https://www.youtube.com/watch?v=DwJusG7VFY0

- 数据结构

  - https://www.youtube.com/watch?v=Jrj0cUK7hp8
    ![image-20220303184046249](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220303184046249.png)

    ```
    {
      "runs": [
        {
          "text": "É O TRAP É O FUNK 🟩\n\nTHE BOX / @oficial.thebox\nMC IG / @ig.4m\nMC GP / @mcgp.oficial\nMC KADU / @mckaduoficial\nMC RUZIKA / @mc_ruzika\n\nINOVANDO A CENA 🟩\n\nFICHA TÉCNICA:\nDireção e realização: @oficial.thebox\nDireção de fotografia e pós-produção: @stopagui\nBeat: @oldi77a\nCaptação: @rotta409\nMix/master: @celo1st"
        }
      ]
    }
    ```

  - https://www.youtube.com/watch?v=XIXxTL35faw
    ![image-20220303184124768](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220303184124768.png)

    ```
    {
      "runs": [
        {
          "text": "Inscreva-se Sonar Produtora\n\nOuça no Spotify: "
        },
        {
          "text": "https://spoti.fi/3lSSlBT",
          "navigationEndpoint": {
            "clickTrackingParams": "CJwBEM2rARgBIhMI9f3v4eCp9gIVLUsPAh1uJw0ISKz75e_LqfzCXA==",
            "commandMetadata": {
              "webCommandMetadata": {
                "url": "https://www.youtube.com/redirect?event=video_description&redir_token=QUFFLUhqbml6RG9mUlNCQXJJQkpSbC05RTAzeFY2UkJFQXxBQ3Jtc0ttS2tMcEFnYkN4dGNmRUJxUHdhdlhzYTg2MGMybGJLNlFBQVpPVTVFVndlQkNLaG40elFWLWhrc21uZmd4MFBLU3BYbkVXeUVnTXBoWmJGYWhnLXBaRnlrWlZvY0hIbzNlU2d0OUJ3MmF2QkdaaGhHZw&q=https%3A%2F%2Fspoti.fi%2F3lSSlBT",
                "webPageType": "WEB_PAGE_TYPE_UNKNOWN",
                "rootVe": 83769
              }
            },
            "urlEndpoint": {
              "url": "https://www.youtube.com/redirect?event=video_description&redir_token=QUFFLUhqbml6RG9mUlNCQXJJQkpSbC05RTAzeFY2UkJFQXxBQ3Jtc0ttS2tMcEFnYkN4dGNmRUJxUHdhdlhzYTg2MGMybGJLNlFBQVpPVTVFVndlQkNLaG40elFWLWhrc21uZmd4MFBLU3BYbkVXeUVnTXBoWmJGYWhnLXBaRnlrWlZvY0hIbzNlU2d0OUJ3MmF2QkdaaGhHZw&q=https%3A%2F%2Fspoti.fi%2F3lSSlBT",
              "target": "TARGET_NEW_WINDOW",
              "nofollow": true
            }
          }
        },
        {
          "text": "\n\nArtista: MC Cebezinho, MC Joãozinho VT, MC Kako, MC GP e MC Vine 7\nMusica: Nos Beat do Dj Boy\nProdução: DJ BOY\nVideoclipe: Opege\n\nProduzido por Sonar Produtora\n\nContrate nossos artistas:\n\n(11) 94734-2016 Juninho Sonar\n(11) 96913-3861 Diego Douetts\n\nSonar Produtora ®\n@Sonarmusicc"
        }
      ]
    }
    ```

  - https://www.youtube.com/watch?v=DwJusG7VFY0
    ![image-20220303184323432](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220303184323432.png)

    ```
    {
      "runs": [
        {
          "text": "Provided to YouTube by Repost Network\n\nMTG -PASSEI A MIL QUEM ME VIU MENTIL (DJ NOVINHO DO VNC Remix) · Mc Poze Do Rodo · DJ NOVINHO DO VNC\n\nMTG -PASSEI A MIL QUEM ME VIU MENTIL\n\n℗ Mc Poze Do Rodo\n\nReleased on: 2022-01-07\n\nAuto-generated by YouTube."
        }
      ]
    }
    ```

    

---

### 本地搭建开发环境



## 2022.03.02

### 测试结果

- trackId 有重复
  444	5605365	0	2022-03-04 08:42:46.000000	SYSTEM	iZq0u3quAqo	444	2022-03-04 08:42:46.000000	100000000052411008  (500 错误)
- trackId 存在
  826	5655013	0	2022-03-04 08:42:46.000000	SYSTEM	6swmTBVI83k	826	2022-03-04 08:42:46.000000	100000000052934000
- trackId 不存在
  374	5604693	0	2022-03-04 08:42:46.000000	SYSTEM	Nj_VnWf6OPM	374	2022-03-04 08:42:46.000000	14



### proud by 

## 2022.03.01

### 解决「如果没有数据,会报 500 」

分别请求 http://localhost:9090/matrix-music-content-server/v1/lrc-lyrics/id?id=5597613
分别请求 http://localhost:9090/matrix-music-content-server/v1/lrc-lyrics/id?id=5602562 

![image-20220301161104273](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220301161104273.png)

发现562 会报 500, 需要解决这个问题

---

### LRCLyric表的数据注入思路



---

### 数据导入的问题

- NewLyricMap 表需要填入 trackId 字段

- 根据 youtube-id 在 SongMap 找, 数量对不上
  ![image-20220301172311831](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220301172311831.png)

- trackId 是错误的-  情况 1

  - 错误 vid youtube-_3z3P_kIkjU
  - 使用 这个 vid 在 songMap 找到 trackId 100000000047741390
  - 使用接口查询 100000000047741390 的数据
    http://api.larkplayerapp.com/ms-song-query-server/v1/song-items/memory/id?id=100000000047741390

- trackId 有些是错误的- 情况 2

  错误 vid youtube-zySXvH5BZqs
  ![image-20220301175632949](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220301175632949.png)
  http://api.larkplayerapp.com/ms-song-query-server/v1/song-items/memory/id?id=100000000062925950
  ![image-20220301175701552](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220301175701552.png)

- - 




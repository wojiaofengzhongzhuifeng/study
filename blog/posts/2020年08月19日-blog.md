# blog系统

- typeorm 需要做的事情（按顺序）

  - 连接数据库
  - 使用 migration 创建表
  - 使用 entity 对表进行操作
    - 声明 entity 类型
    - 创建数据关联   

- 如何使用 typeorm migration 对表进行追加 column 操作

- 数据库统一风格模板表格

  studentRanks

- | id   | rank | studentName | createdAt | updateAT |
  | ---- | ---- | ----------- | --------- | -------- |
  |      |      |             |           |          |





## 操作记录

- 使用 docker 起一个postgresql 服务

  执行的操作， 

  ```
  docker run -v "$PWD/blog-data":/var/lib/postgresql/data -p 5432:5432 -e POSTGRES_USER=blog -e POSTGRES_HOST_AUTH_METHOD=trust -d b98d1e0a90de
  
  ```

- 常用 PostgreSQL 命令行

  ```
  # 以 用户名为 blog 密码为 123 的账户进入数据库
  psql -U blog -W 123
  
  # 显示所有数据库
  \l
  
  # 进入某个数据库
  \c xxxx
  
  # 显示数据库表格
  \dt
  
  # 删除数据库表格
  drop table xxxx
  
  # 生成数据库
  CREATE DATABASE blog_dev_1 ENCODING 'UTF8' LC_COLLATE 'en_US.utf8' LC_CTYPE 'en_US.utf8';
  ```

- 在 next 中引入 ts，目标yarn dev 正常

  - 添加 tsconfig.json 
  - yarn dev 发现报错
  - 安装依赖，将某个文件从 jsx 换成 tsx
  - 发现 tsx 都是报错，原来是tsconfig.json 没有配置好

  

- 在 next 中导入 pg，目标是能在 next 中打印 connect 

  ```
  
  yarn add typeorm reflect-metadata pg
  
  yarn add @types/node --dev
  ```

- 出现的问题

  现有项目 next ，使用 babel 将ts 转成 js；

  typeorm 使用 ts-node 将 ts 转成 js；

  应该统一使用 babel 将 ts 转成 js；

- typeorm 不能做的事情

  无法创建数据库

- 需求：typeorm migration 创建表格 + 定义表格列属性， 目标通过typeorm 提供的api 能为数据库创建表格

  - cli 生成初始化migration 模板代码

    ```sh
    typeorm migration:create -n CreateTtttt
    ```

  - 通过 migration 定义 table columns

  - 使用 babel 将 ts 转为 js

    ```
    babel ./src --out-dir dist --extensions .ts,.tsx
    ```

  - 运行migration
    这个代码会根据json 文件的配置运行 js 文件

    ![image-20200822060329110](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20200822060329110.png)

    ​	typeorm migration:run + ormconfig.json 的运行结果是：

    ​	运行 dist/migration/\*\*/*.js 所有文件

    ​	简写为

- package简写操作

  ```sh
  # 原命令
  typeorm migration:create -n CreateTtttt
  
  # 简化命令
  yarn m:c -n CreateTtttt
  ```

- 创建 entity(使用类和对象操作)

  ```
  typeorm entity:create -n Student
  ```

- 重新整理一下创建数据流程

  目标： 创建一个 Person 表格，内部 column 是 id，name，age，并且需要往这个表格填入数据

  1. yarn m:c -n Person（但是别人是 createPersons）

  2. 修改 src/migration/Persons.ts 的代码(特别注意，必须是 person ，需要小写，并且是复数，错了好多次了)(但是别人是 persons)

     ![image-20200822090213072](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20200822090213072.png)

  3. yarn m:r

  4. yarn e:c -n Person

  5. 修改 src/entity/Person.ts 的代码

  6. 在 src/index.ts 中使用 Person entity 类

  7. node ./dist/index.js

- seed 数据

- 重新开机，发现数据库连不上，使用 docker ps 发现没有运行的容器，

  ```
  docker restart containerId
  ```

- --- 【博客系统】数据库设计与搭建开始 --- 

- 如何为追加 columns？

  目标：需要为 posts 表追加 create_at, update_at columns

- 如何修改 columns 名称？

  目标：需要将 posts 的 create_at 改成 createAt， update_at 改成 updateAt

- 为何要创建数据关联？
  现有的表格 column

  comments

  | id   | content |
  | ---- | ------- |
  |      |         |

  posts

  | id   | title | content |      |
  | ---- | ----- | ------- | ---- |
  |      |       |         |      |

  users

  | id   | username | passwordDigest |
  | ---- | -------- | -------------- |
  |      |          |                |
  |      |          |                |
  |      |          |                |

- post 为什么会这样定义
  ![image-20200824175806007](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20200824175806007.png)

  ![image-20200824175854465](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20200824175854465.png)

- createAt 的数据类型的最佳实践是什么

- 先定义 migration， 在定义 entity

- --- 【博客系统】数据库设计与搭建结束 --- 




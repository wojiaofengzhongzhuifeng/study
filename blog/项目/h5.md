





## 新增需求

- 接入微信验证

- 使用加密方式对用户的操作进行校验, 防止其他人恶意向数据库注入数据

- 接入平安公众号

- localStorage 如何保证保存最新的 token?

  - 情况

    - 没有 key: 直接 setItem

    - 有 key 有 value: 直接 setItem

      


## 如何把本地代码 push 到服务器的某个目录下

- 预期效果

    开发机器通过 `git push`, 可以将代码推送到服务器中 

- 核心流程
  
    - 服务器创建用户
    
        ```
        sudo adduser git-test # 创建 git-test 用户
        ```
        
    - 服务器创建 bare 仓库
    
        ```
        mkdir /data/nginx-new/html/git-hooks # 根据实际修改位置
        cd /data/nginx-new/html/git-hooks
        git init --bare back-h5-git.git
        ```
    
    - post-receive 修改
    
        ```
        #!/bin/sh
         
        unset GIT_DIR
        cd /data/nginx-new/html/back-h5-git  # 代码仓库的位置
        git pull
        ```
    
    - 创建代码仓库
    
        ```
        cd /data/nginx-new/html
        git clone /data/nginx-new/html/git-hooks/back-h5-git.git
        ```
    
    - 添加权限
    
        ```
        cd /data/nginx-new/html/git-hooks/back-h5-git.git/hooks
        chmod +x post-receive
        sudo chown -R git-test:git-test /data/nginx-new/html/git-hooks/back-h5-git.git # bare 仓库路径
        sudo chown -R git-test:git-test /data/nginx-new/html/back-h5-git # 代码仓库路径
        sudo chown -R git-test:git-test /home/git-test # 用户路径
        ```
    
    - 开发机器 git clone
    
        ```
        git clone git-test@203.195.221.250:/data/nginx-new/html/git-hooks/back-h5-git.git
        ```
    
## 请求参数

请求参数, 有几种方式

- 将参数放到 url 的 path 中

    前端这样请求 `/video/1`
    
    后端这样获取
    
    ```javascript
    app.get('/getVideoUrl/:id', async (req) => {
      console.log(req.params.id);
    });
    ```
  
- 将参数放到 url 的 query 中

    前端这样请求 `/video?id=1`
    
    后端这样获取
    
    ```javascript
    app.get('/getVideoUrl', async (req) => {
      console.log(req.query);
    });
    ```
  
- 前端为了区分每一期, 使用 `/info/1`

- 后端为了区分每一期, 不能使用 `/info/1` 
  



## 定义变量需要注意的地方

现有如下代码

```javascript
try {
  // 可能是 userData = [{lotteryTime: 1, prizeLevel: 1}]
  const userData = [];
  
  // 如果是 [], 下面的 2 句代码会报错, 所以要进行防御性编程
  // const lotteryTime = userData[0].lotteryTime;
  // const prizeLevel = userData[0].prizeLevel;
  
  // 防御性代码
 	const lotteryTime = userData && userData[0] && userData[0].lotteryTime || 0;
  const prizeLevel = userData && userData[0] && userData[0].prizeLevel || 0;

  if(userData.length !== 0 && lotteryTime < 5 - 1 && prizeLevel == 0){
    console.log(1)
  } else {
    console.log(2)
  }
} catch (e) {
  console.log(e)
}
```



## 数据库大小写

![image-20200122102436540](/Users/raojj/Library/Application Support/typora-user-images/image-20200122102436540.png)





## git push 之前必须保证服务器退出 vim 编辑





## 通过 select SQL 获取的是数组

```
const result = await sql(`select * from md5_${id} where used=0 order by rand() limit 1;`);
result 是一个数组
```



## SQL 数据类型与 js 数据类型对应

| SQL  | js     |
| ---- | ------ |
| int  | number |
|      |        |
|      |        |



## 对象数据结构关系

现有如下代码

```javascript
const response = await axiosInstance.get(`/lottery?id=${id}&number=${window.userNumber}`);
```

在 postman 返回的是

![image-20200122153953267](/Users/raojj/Library/Application Support/typora-user-images/image-20200122153953267.png)

`response.data` === postman 返回的数据





## 抽奖逻辑

1. 全对, 使用`get/user`获取用户数据, 只有当「number 合法 + 次数不超过最大抽奖次数 + 未中奖」, 才可以抽奖
   1. 不合法人员, 直接进入感谢观看
   2. 合法人员
      1. 可以抽奖, 进入抽奖页面
         1. 调用 `get/lottery`
            1. 中奖, 进入邮寄信息页面, 使用 `post/info` 进行记录数据
            2. 未中奖, 进入结算页面
      2. 不可以抽奖, 进入结算页面



## 如何收集用户的中奖信息

- 直接在表`users_id`记录用户的中奖信息即可
- 前端需要收集 以下数据
  - phone
  - address(级联选择收集数据)
  - 收货人



## 数据库返回的数据格式

1. select 语句

   ![image-20200127120336619](/Users/raojj/Library/Application Support/typora-user-images/image-20200127120336619.png)







## ubuntu 下如何结束 node 服务??

- 端口号与进程id(PID)的区别

  - 端口号用来表示「这个特殊进程是用于通信的」, 即**PID范围比端口号大**
  - 例子: 你在 3333 端口开启一个 chrome 服务, 每一个 tab 都对应一个 PID

- 输入进程名称, 输出PID

  `ps -ef | grep node`

  返回如下内容

  ```
  ubuntu    5377  5301  0 21:58 pts/0    00:00:00 node lottery-backend.js
  ubuntu   13950 13919  0 22:53 pts/2    00:00:00 grep --color=auto node
  ```

  可知 PID = 5377

- 根据PID, 结束服务

  `kill -9 PID`

- 输入 PID, 输出端口号

  `netstat -nap | grep 5377`

- 输入端口号, 输出PID

  `netstat -nap | grep 8081`









## 使用企业微信的过程

- 获取 access_token

  https://work.weixin.qq.com/api/doc/90000/90135/91039

- 构造网页授权链接, 获取 code

  https://work.weixin.qq.com/api/doc/90000/90135/91022

- 获取访问用户身份, 获取 userId
  https://work.weixin.qq.com/api/doc/90000/90135/91437

- 读取成员, 获取 number

  https://work.weixin.qq.com/api/doc/90000/90135/90196







## 需要做的事情

- 代码流程再看一遍

- 苹果, 安卓手机缩略图

- 重点: 添加接口「post/userData」, 如果经过企业认证, 往表格内添加数据, **这个接口非常重要, 需要一定安全性**

- users_id 表格数据可能的情况

  - | 数据含义               | number(工号) | lotteryTime(抽奖次数) | prizeLevel(中奖等级) | haveInputInfo(是否填写邮寄信息) | lotteryMD5(中奖 MD5) | phone | address | name(收件人) | 结果 |
    | ---------------------- | ------------ | --------------------- | -------------------- | ------------------------------- | -------------------- | ----- | ------- | ------------ | ---- |
    | 验证通过               | test1        | 0                     | 0                    | 0                               |                      |       |         |              |      |
    | 未中奖                 | test2        | 5                     | 0                    | 0                               |                      |       |         |              |      |
    | 中奖                   | test3        | 2                     | 2                    | 1                               | fdafdsfdsa           | 110   | 深圳    | 饶家俊       |      |
    | 中奖且未填写           | test4        | 3                     | 2                    | 0                               | Fffffccbvbvb         |       |         |              |      |
    | 未中奖且未使用全部次数 | test5        | 2                     | 0                    | 0                               |                      |       |         |              |      |
    |                        |              |                       |                      |                                 |                      |       |         |              |      |

    

- 手动验证改成进入应用后, 静默验证

  经过企业验证后, 使用接口「addUsers_id」往 users_id 表添加数据, 并且设置 window.number = 'anbo'





## 流程

- 需求: 使用企业微信获取用户信息(不考虑 access_token)

  1. 获取 code : https://work.weixin.qq.com/api/doc/90000/90135/91022

     前端写一个函数, 获取 url 的 code, 并且把 code 放到 window 上即可

  2. 获取 access_token: https://work.weixin.qq.com/api/doc/90000/90135/91039
     - 获取token接口在后端
     - 在redis搜索有没有 token(使用 redis 代替mysql)
       - 如果没有 token, 调用微信提供的接口, 将 token 放到数据库中, 并且设置过期时间(7200), 将 token 返回给前端
       - 如果有,直接返回数据库保存的 token

  3. 获取详细信息: https://work.weixin.qq.com/api/doc/90000/90135/91023#10019
     
     - 获取 userId: https://work.weixin.qq.com/api/doc/90000/90135/91023

- 需求: 如何安装 redis?

  ```
  $ apt-get update
  $ apt-get install redis-server
  ```

- 需求:如何配置jenkins ,可以让 jenkins 知道我 push 了代码?

  - https://juejin.im/post/5dca691ff265da4d4b5ff2f5#heading-10 不要 gitwebhooks

- 需求: 前端部署, 如果package.json 没有发生变化,那么不执行 yarn 

- 需求: 如何将服务器的表格下载到本地 mac?

  ![image-20200311103129082](/Users/raojj/Library/Application Support/typora-user-images/image-20200311103129082.png)

  ![image-20200311103216169](/Users/raojj/Library/Application Support/typora-user-images/image-20200311103216169.png)

- 需求: 目前的流程是怎么样的?

  - 进入页面, 点击第二期

    修改后的流程: 进入页面, 发送 `post/userData` 初始化员工数据

  - 观看湾完视频, 进入 check 组件,用于判断是否是内部员工

    修改后的流程: 看完视频后, 后台检查是否内部员工

  - 抽奖逻辑

- 数据库设计

    - | 数据含义               | number(工号) | lotteryTime(抽奖次数) | prizeLevel(中奖等级) | haveInputInfo(是否填写邮寄信息) | lotteryMD5(中奖 MD5) | phone | address | name(收件人) | 结果 |
      | ---------------------- | ------------ | --------------------- | -------------------- | ------------------------------- | -------------------- | ----- | ------- | ------------ | ---- |
      | 验证通过(初始化)       | test1        | 0                     | 0                    | 0                               |                      |       |         |              |      |
      | 未中奖                 | test2        | 5                     | 0                    | 0                               |                      |       |         |              |      |
      | 中奖                   | test3        | 2                     | 2                    | 1                               | fdafdsfdsa           | 110   | 深圳    | 饶家俊       |      |
      | 中奖且未填写           | test4        | 3                     | 2                    | 0                               | Fffffccbvbvb         |       |         |              |      |
      | 未中奖且未使用全部次数 | test5        | 2                     | 0                    | 0                               |                      |       |         |              |      |
      |                        |              |                       |                      |                                 |                      |       |         |              |      |

  







## 问题

- 进入「欢乐 PA应用」方式是「微信」还是「企业微信」?

  我的理解是只能「企业微信」,因为只有企业微信才知道你是不是「企业内部员工」







## bug 的复现

- 进入应用后, 超过 10 分钟才看完有没有问题?
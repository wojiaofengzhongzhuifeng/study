## é¢„ä¹ 



## æµè§ˆå™¨çš„å­˜å‚¨

### cookie çš„ set ä¸ get

set æ˜¯ http å“åº”ä¿¡æ¯çš„ http ç¬¬äºŒéƒ¨åˆ†è®¾ç½®çš„

![image-20220924105100759](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220924105100759.png)

### cookie çš„é™åˆ¶

---

### cookieçš„ key å’Œ value éƒ½éœ€è¦ç»è¿‡ url ç¼–ç æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

![image-20220924105516716](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220924105516716.png)

![image-20220924105843141](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220924105843141.png)

![image-20220924105845673](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220924105845673.png)

---

### url ç¼–ç æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

---

### cookie åŸŸ

- å¦‚æœè®¾ç½®åŸŸä¸º .wrox.comï¼Œ è¡¨ç¤ºå¯¹ wrox.com çš„æ‰€æœ‰å­åŸŸéƒ½æœ‰æ•ˆ
- å¦‚æœè®¾ç½®åŸŸä¸º www.wrox.comï¼Œå¯¹ h5.wrox.com æœ‰æ•ˆï¼Ÿ

---

### ä½¿ç”¨ js è®¾ç½® cookie ä¸ä¼šè¦†ç›–åŸ cookie é™¤éåŒå name

---

### cookie æ¯æ¬¡è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šï¼›storage ä¸ä¼š

---

###è®¿é—®åŒä¸€ä¸ª localStorage å¯¹è±¡ï¼Œé¡µé¢å¿…é¡»æ¥è‡ªåŒä¸€ä¸ªåŸŸï¼ˆå­åŸŸä¸å¯ä»¥ï¼‰ã€åœ¨ç›¸åŒçš„ç«¯å£ä¸Šä½¿ç”¨ç›¸åŒçš„åè®®

---

### indexDb è¿™ä¸ªç”¨çš„æ¯”è¾ƒå°‘æŠŠï¼Ÿ

---

### å„ç§å­˜å‚¨çš„æ¯”è¾ƒ

---

### ä¸‰ä¸ªé˜¶æ®µ

äº‹ä»¶æµåˆ†ä¸º 3 ä¸ªé˜¶æ®µï¼šäº‹ä»¶æ•è·ã€åˆ°è¾¾ç›®æ ‡å’Œäº‹ä»¶å†’æ³¡

äº‹ä»¶æ•è·çš„ç›®çš„å¯ä»¥æå‰æ‹¦æˆªç›®æ ‡äº‹ä»¶

æ­£å¸¸å¼€å‘éƒ½æ˜¯å†’æ³¡



## ç›´æ’­ç¬”è®°

### ä¸¤ä¸ªä¸åŒçš„ tab é¡µå¦‚ä½•å®ç°é€šä¿¡ï¼ˆä¸¤ä¸ªtabé¡µéƒ½æ˜¯è‡ªå·±é¡¹ç›®å¯æ§åˆ¶çš„é¡µé¢ï¼‰

å¦‚æœåŒåŸŸ

- websocket
- postMessage
- localStorage
- server worker 

å¦‚æœåŸŸåä¸åŒï¼Œæ‰‹åŠ¨æ‰“å¼€ url1ï¼Œæ‰‹åŠ¨æ‰“å¼€ url2ï¼Œå¹¶ä¸” url1 å’Œ url2 éƒ½æ˜¯æˆ‘ä»¬å…¬å¸

- postMessage å’Œ localstorage ç»“åˆ

  ![image-20220924174046782](https://raw.githubusercontent.com/wojiaofengzhongzhuifeng/iamge-host-2/master/image-20220924174046782.png)

  - ç°æœ‰ä¸‰ä¸ªé¡µé¢ï¼šé¡µé¢ Aï¼Œé¡µé¢ Bï¼Œé¡µé¢ B å†…éšè—çš„ A åŒåŸŸåçš„ iframe
  - é¡µé¢ A ä¸ A iframe å¯ä»¥é€šè¿‡ localStorage é€šä¿¡
  - é¡µé¢ B ä¸ A iframe å¯ä»¥é€šè¿‡ postMessage é€šä¿¡
  - è¾¾åˆ°é¡µé¢ A ä¸é¡µé¢ B é€šä¿¡æ•ˆæœ

---

### e.stopprogationä½œç”¨

é˜»æ­¢äº‹ä»¶ç»§ç»­ä¼ æ’­ï¼Œå¹¶ä¸æ˜¯å•å•é˜»æ­¢äº‹ä»¶å†’æ³¡

---

### ä¸‰ä¸ªé˜¶æ®µçš„æ‰§è¡Œé¡ºåº

- æ•è·é˜¶æ®µæ¯”å†’æ³¡é˜¶æ®µå…ˆè§¦å‘
- å•é˜¶æ®µï¼ˆæ•è·ã€ç›®æ ‡ã€å†’æ³¡ï¼‰ç»‘å®šå¤šä¸ªäº‹ä»¶ï¼Œè°å…ˆç»‘å®šè°å…ˆè§¦å‘

---





## ç¬”è®°

### ğŸ”´ æµè§ˆå™¨å„ç§å­˜å‚¨æ–¹æ¡ˆçš„æ¯”è¾ƒ

### ä¸¤ä¸ªé¡µé¢é€šä¿¡æ–¹å¼ - postMessage

- å¯ä»¥å®ç°è·¨åŸŸé€šä¿¡
- ä¸¤ä¸ªé¡µé¢å¿…é¡»æœ‰å…³ç³»ï¼Œå¦‚
  -  between a page and a pop-up that it spawned => é¡µé¢ 2 ç”± é¡µé¢ 1 æ‰“å¼€
  - between a page and an iframe embedded within it => é¡µé¢å­˜åœ¨åµŒå¥—

- demo

  https://github.com/wojiaofengzhongzhuifeng/postMessageTwoPageDemo/tree/main

### äº‹ä»¶è§¦å‘æœºåˆ¶





## ä½œä¸š

### æè¿°ä¸€ä¸‹æµè§ˆå™¨æœ¬åœ°å­˜å‚¨æœ‰å“ªäº›æ–¹å¼å’ŒåŒºåˆ«

- cookie 
- storage
  - sessionStorage
  - localStorage
- indexDB

### onclick å’Œ addEventListener æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

- onClick åªèƒ½æŒ‚è½½åœ¨äº‹ä»¶çš„å†’æ³¡é˜¶æ®µ
- å¤šæ¬¡é€šè¿‡ onclick ç›‘å¬äº‹ä»¶ï¼Œåªä¼šä¿ç•™æœ€åä¸€ä¸ªäº‹ä»¶ç›‘å¬å‡½æ•°

### æ•è·é˜¶æ®µçš„äº‹ä»¶ä¸€å®šæ¯”å†’æ³¡é˜¶æ®µçš„äº‹ä»¶å…ˆæ‰§è¡Œå—ï¼Ÿä¸ºä»€ä¹ˆ

æ˜¯çš„

### æè¿°ä¸€ä¸‹äº‹ä»¶ä»£ç†çš„åŸç†åŠä¼˜ç¼ºç‚¹ï¼ˆæˆ–ä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼‰

è§£å†³ç®¡ç†åŠ¨æ€å˜åŒ– DOM çš„äº‹ä»¶ç›‘å¬é—®é¢˜

### æ˜¯å¦æ‰€æœ‰äº‹ä»¶éƒ½å¯ä»¥ä½¿ç”¨äº‹ä»¶ä»£ç†ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

å¦‚æœäº‹ä»¶å¯ä»¥å†’æ³¡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨äº‹ä»¶ä»£ç†ï¼Œå¦‚ focus æ— æ³•ä½¿ç”¨äº‹ä»¶ä»£ç†

### ç¼–ç é¢˜ï¼ˆé¢è¯•é¢˜ï¼‰ï¼šè‡ªå®šä¹‰äº‹ä»¶ç»‘å®šå’Œè§¦å‘ï¼Œæ¯”å¦‚å¯ä»¥ç»‘å®šä¸€ä¸ªè‡ªå®šä¹‰çš„åç§° customClick,å¹¶ä¸”å¯ä»¥é€šè¿‡ä»£ç è§¦å‘å®ƒã€‚

å³ï¼šå†™ä¸€ä¸ªç±»æˆ–è€…åŒ¿åå‡½æ•°ï¼Œæœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªbindï¼Œä¸€ä¸ªtriggerï¼Œä¸€ä¸ªunbindï¼Œåˆ†åˆ«å®ç°ç»‘å®šäº‹ä»¶å’Œè§¦å‘äº‹ä»¶(å¦‚æœå®ç°onceæ›´å¥½)

```javascript
class MyEvent{}
const myEvent = new MyEvent
myEvent.bind('event1', fun1)
myEvent.bind('event1', fun2)
myEvent.bind('event2', fun3)
myEvent.bind('event2', fun4)

myEvent.trigger('event1', data)
myEvent.trigger('event2', data)
```

æç¤ºï¼ˆé¢è¯•å®˜ä¸ä¼šæœ‰æ­¤æç¤ºï¼‰ï¼š

åœ¨bindå’Œtriggerå‡½æ•°å¤–å±‚ä½œç”¨åŸŸåˆ›å»ºä¸€ä¸ªå­—å…¸å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨æ³¨å†Œçš„äº‹ä»¶åç§°å’Œäº‹ä»¶å¤„ç†å‡½æ•°åˆ—è¡¨ã€‚bindæ—¶ï¼Œå¦‚æœå­—å…¸æ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªï¼Œkeyæ˜¯äº‹ä»¶åç§°ï¼Œvalueæ˜¯æ•°ç»„ï¼Œé‡Œé¢æ”¾ç€å½“å‰æ³¨å†Œçš„å“åº”å‡½æ•°ã€‚å¦‚æœå­—æ®µæ±‡æ€»æœ‰ï¼Œé‚£ä¹ˆå°±ç›´æ¥pushåˆ°æ•°ç»„ä¸­å³å¯ã€‚triggeræ—¶è°ƒå‡ºæ¥ä¾æ¬¡è§¦å‘äº‹ä»¶å“åº”å‡½æ•°å³å¯ã€‚

ï¼ˆå‘å¸ƒè®¢é˜…ã€å¼‚æ­¥ã€unbindï¼‰

å‚è€ƒä»£ç 

```javascript
class EventEmitter {
  constructor() {
    // å­˜å‚¨äº‹ä»¶ä¸äº‹ä»¶å¤„ç†å‡½æ•°ä¹‹é—´çš„å¯¹åº”å…³ç³»
    this.eventMap = Object.create(null);
  }

  /**
   * ç»‘å®šäº‹ä»¶
   * @param {String} type äº‹ä»¶ç±»å‹
   * @param {Function} handler äº‹ä»¶å¤„ç†å‡½æ•°
   */
  bind(type, handler) {
    if (!handler instanceof Function) {
      throw new Error("the handler must be a function");
    }

    if (!this.eventMap[type]) {
      this.eventMap[type] = [];
    }

    this.eventMap[type].push(handler);
  }

  /**
   * è§¦å‘äº‹ä»¶
   * @param {String} type äº‹ä»¶ç±»å‹
   * @param {Array} args äº‹ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ç»„æˆçš„æ•°ç»„
   */
  trigger(type, ...args) {
    // å¤šæ¬¡ once æ—¶ï¼Œåœ¨ trigger çš„æ—¶å€™è¾¹å¾ªç¯è¾¹ä» handlers é‡Œé¢åˆ é™¤ï¼Œä¼šå¯¼è‡´å¾ªç¯çš„æ—¶å€™è·³è¿‡å‡½æ•°
    // æ¯”å¦‚ once äº†ä¸¤æ¬¡ï¼Œæ­¤æ—¶ handlers ä¸­å­˜åœ¨ä¸¤é¡¹ï¼Œå½“åœ¨ trigger éå†åˆ°ç¬¬ä¸€ä¸ª handler æ—¶ï¼Œä¼šå°†å…¶åˆ æ‰
    // æ­¤æ—¶ handlers åªå­˜åœ¨ä¸€é¡¹ï¼Œç„¶å trigger éå†ç¬¬äºŒä¸ªï¼Œå‘ç° handlers ä¸­æ²¡æœ‰ç¬¬äºŒä¸ªï¼Œå°±ä¼šç»“æŸå¾ªç¯
    // å¯¼è‡´ once ä¸­çš„äº‹ä»¶å¤„ç†å‡½æ•°åªæ‰§è¡Œäº†ä¸€æ¬¡
    // æ‰€ä»¥è¿™é‡Œéœ€è¦æµ…å…‹éš†ä¸€ä»½ handlers
    const handlers = this.eventMap[type].slice();
    handlers.forEach((handler) => handler(...args));
  }

  /**
   * ç§»é™¤äº‹ä»¶
   * @param {String} type äº‹ä»¶ç±»å‹
   * @param {Function} handler äº‹ä»¶å¤„ç†å‡½æ•°
   */
  remove(type, handler) {
    if (this.eventMap[type]) {
      const index = this.eventMap[type].indexOf(handler);
      
      this.eventMap[type].splice(index, 1);
    }
  }
  
  /**
   * ä¸ bind ç±»ä¼¼ï¼Œä½†åœ¨ trigger ä¸€æ¬¡ååˆ é™¤å›è°ƒ
   * @param {String} type äº‹ä»¶ç±»å‹
   * @param {Function} handler äº‹ä»¶å¤„ç†å‡½æ•°
   */
  once(type, handler) {
    const wrapper = (...args) => {
      handler(...args);

      this.remove(type, wrapper);
    };

    this.bind(type, wrapper);
  }
}

const em = new EventEmitter();

function handler() {
  console.log(...arguments);
}

em.once("aaa", handler);
em.once("aaa", handler);
em.trigger("aaa", 10);

// ä¸ä¼šæœ‰ä»»ä½•è¾“å‡º
em.trigger("aaa", 10);
```